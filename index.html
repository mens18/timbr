<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timbratura</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FingerprintJS/3.3.6/fingerprint2.min.js"></script>
</head>
<body>
    <h2>Timbratura</h2>
    
    <label for="nome">Nome:</label>
    <select id="nome">
        <option value="Antonino Stefania">Antonino Stefania</option>
        <option value="Bonasia Domenico">Bonasia Domenico</option>
        <option value="Calabrese Giuseppe Pio">Calabrese Giuseppe Pio</option>
        <option value="Campese Daniela">Campese Daniela</option>
        <option value="Cappilli Francesca">Cappilli Francesca</option>
        <option value="Caprioli Giovanni">Caprioli Giovanni</option>
        <option value="Caputo Carlo">Caputo Carlo</option>
        <option value="Cassanelli Letizia">Cassanelli Letizia</option>
        <option value="Chiarazzo Maria">Chiarazzo Maria</option>
        <option value="Corvasce Simona Isabela">Corvasce Simona Isabella</option>
        <option value="Doronzo Ruggiero">Doronzo Ruggiero</option>
        <option value="Faleo Francesca">Faleo Francesca</option>
        <option value="Fiorella Umberto">Firoella Umberto</option>
        <option value="La Notte Luca">La Notte Luca</option>
        <option value="Longo Raffaele">Longo Raffaele</option>
        <option value="Lopolito Nicola">Lopolito Nicola</option>
        <option value="Mancini Enrico">Mancini Enrico</option>
        <option value="Manzi Giovanni">Manzi Giovanni</option>
        <option value="Marinaro Michela">Marinaro Michela</option>
        <option value="Mennuni Francesco">Mennuni Francesco</option>
        <option value="Miccoli Federica">Miccoli Federica</option>
        <option value="Partucci Giorgia">Partucci Giorgia</option>
        <option value="Pazienza Simona">Pazienza Simona</option>
        <option value="Petrone Giuseppe">Petrone Giuseppe</option>
        <option value="Russo Lorenzo">Russo Lorenzo</option>
        <option value="Spina Arianna">Spina Arianna</option>
        <option value="Trione Pietro">Trione Pietro</option>
        <option value="Vischi Vittoria">Vischi Vittoria</option>
    </select>
    
    <label for="tipo">Tipo:</label>
    <select id="tipo">
        <option value="ingresso">Ingresso</option>
        <option value="uscita">Uscita</option>
    </select>

    <label for="sede">Sede:</label>
    <select id="sede">
        <option value="Andria">Andria</option>
        <option value="Barletta">Barletta</option>
        <option value="Bisceglie">Bisceglie</option>
        <option value="Trani">Trani</option>
    </select><br><br>
    
    <button onclick="timbratura()">Timbra</button>
    
    <script>
        function getCookie(name) {
            let match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
            return match ? match[2] : null;
        }

        function setCookie(name, value, days) {
            let expires = new Date();
            expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
            document.cookie = name + "=" + value + "; path=/; expires=" + expires.toUTCString();
        }

        function generateDeviceID() {
            let deviceID = getCookie("deviceID");
            if (!deviceID) {
                deviceID = crypto.randomUUID();
                setCookie("deviceID", deviceID, 365 * 10);
            }
            return deviceID;
        }

        function getFingerprint(callback) {
            Fingerprint2.get(components => {
                let values = components.map(component => component.value);
                let fingerprint = Fingerprint2.x64hash128(values.join(''), 31);
                callback(fingerprint);
            });
        }

        function getLocationAndSendData(fingerprint, deviceID) {
            navigator.geolocation.getCurrentPosition(position => {
                let lat = position.coords.latitude;
                let lon = position.coords.longitude;
                let nome = document.getElementById("nome").value;
                let tipo = document.getElementById("tipo").value;
                
                let url = "https://script.google.com/macros/s/AKfycbwh_0_wmJhVAcq7J6gzRhzA73mkcYtRDAuEJm2E4mp1R9LE6YOzqGs42EUifb_NhJ_S8A/exec" + 
                          "?nome=" + encodeURIComponent(nome) + 
                          "&tipo=" + encodeURIComponent(tipo) + 
                          "&gps=" + encodeURIComponent(lat + "," + lon) +
                          "&deviceId=" + encodeURIComponent(deviceID) + 
                          "&fingerprint=" + encodeURIComponent(fingerprint);

                fetch(url)
                    .then(response => response.text())
                    .then(data => alert(data))
                    .catch(error => console.error('Errore:', error));
            }, () => alert("Abilita la geolocalizzazione per timbrare."));
        }

        function timbratura() {
            let deviceID = generateDeviceID();
            getFingerprint(fingerprint => {
                getLocationAndSendData(fingerprint, deviceID);
            });
        }
    </script>
</body>
</html>
